# Vermelha（ヴェルメーリャ） v1 仕様書

**バージョン: 1.0 Draft (2026-01-01)**

## 1. 概要

### 1.1 コンセプト
Wizardryライクなキャラクター育成・ダンジョン探索と、Final Fantasy XIIのガンビットのようなルールベースの自動戦闘を組み合わせた、テキスト中心のRPG。メニューはWizardry風のテキスト選択を基本とし、ログの読みやすさを重視する。スマートフォンでの隙間時間のプレイに最適化する。

### 1.2 ゲームのコアサイクル
1.  **街 (City):** パーティ編成、キャラクター管理、装備の変更、戦法（ガンビット）の編集、アイテムの売買など、探索の準備を行う。
2.  **ダンジョン (Dungeon):** 到達済みのフロアを選択し、探索を開始する。
3.  **自動探索:** 探索は自動で進行し、移動、敵との遭遇、戦闘、戦利品の獲得がログに記録される。
4.  **自動戦闘:** 戦闘は各キャラクターに設定されたガンビット（if-then形式のルール）に従って、全自動で進行する。
5.  **戦利品:** ゴールドやアイテムを獲得し、装備更新でパーティを強化する（v1実装では経験値/レベルアップは未実装）。
6.  **帰還:** 目的を達成したり、インベントリが一杯になったり、全滅した場合は街に帰還し、次の探索に備える。

### 1.3 対象プラットフォーム
-   **v1:** Flutterを使用し、iOS / Androidのスマートフォンを主要ターゲットとする。
-   **将来:** デスクトップ、Webへの展開も視野に入れる。

### 1.4 ローカライゼーション
-   **v1:** 日本語のみ。
-   **v2以降:** 英語対応を予定。実装はi18nを前提とし、文字列はハードコーディングしない。

### 1.5 UI/UX 方針 (スマホ優先)
-   片手操作を想定し、主要操作は縦一列のリストまたはボタンで完結させる。
-   1画面1目的を優先し、深い階層や複雑なジェスチャーは避ける。
-   探索/戦闘は自動進行、ログは時系列で上から下へ流れる形式。
-   いつでも `Pause/Play` で中断・再開できる設計にする。

---

## 2. ゲームシステム

### 2.1 キャラクターとジョブ
パーティは3人のキャラクターで構成される。キャラクター作成時に、以下のジョブから1つを選択する。

-   **v1におけるジョブの扱い:**
    -   キャラクターの役割を示すフレーバーとして機能する。
    -   ステータスの成長率や習得スキルに**大きな差はない**が、初期装備やごく基本的な特性が異なる程度とする。
    -   本格的なジョブの差別化はv2以降の目標とする。

-   **ジョブ一覧 (v1):**
    1.  `Fighter` (戦士): 前衛。攻守のバランスが良い。
    2.  `Paladin` (騎士): 前衛。防御と自己回復に長ける。
    3.  `Ranger` (野伏): 後衛。弓による攻撃が主体。
    4.  `Wizard` (魔術師): 後衛。攻撃魔法の専門家。
    5.  `Shaman` (巫師): 中衛。敵への妨害や補助魔法を使う。
    6.  `Priest` (僧侶): 中衛/後衛。回復魔法の専門家。

#### 2.1.1 キャラクター作成・編集・削除
-   **作成:** 名前 + ジョブを選択し、初期装備と初期ステータスで作成する。
-   **初期ステータス:** ジョブ差を持たせる (v1では小さな差)。
-   **数値レンジ:** v1では暫定とし、プレイしながら調整する。
-   **ジョブ変更:** 作成後のジョブ変更は不可。
-   **編集:** 名前変更、装備/所持品の管理、優先パラメータ編集、ガンビット編集へ遷移できる。
-   **削除:** 確認ダイアログを出し、削除後は復元不可。

#### 2.1.2 パーティ編成
-   **出撃パーティ:** 常に3人固定。ダンジョン出撃は3人が揃っていることが条件。
-   **配置:** `前衛/中衛/後衛` の3スロットに割り当てる。

### 2.2 戦闘システム
-   **形式:** ターン制バトル。
-   **進行:** 各キャラクターの`speed`（素早さ）に基づいて行動順が決定され、ガンビットに従って自動で行動する。
-   **ターン消費:** スキルや魔法の使用、アイテムの使用は1ターンを消費する。
-   **パーティ構成:** `前衛 (Forward)` `中衛 (Middle)` `後衛 (Rear)` の3人固定。
-   **行動決定:** 優先度順にガンビットを評価し、条件を満たし実行可能なアクションを選択する。
-   **フォールバック:** 実行可能なルールがない場合、`通常攻撃` を行う。
-   **v1実装メモ:** 各行動は完了までに時間がかかるタスクとして扱われます。v1では一度に一つの行動のみが実行されます。

### 2.3 ガンビット（戦法）
戦闘行動は、優先順位の高いルールから評価されるif-then形式の「ガンビット」によって決定される。

-   **ルール構成:** `ガンビット = 条件 (Condition) + ターゲット (Target) + アクション (Action)`
-   **評価タイミング:** 各キャラクターの行動決定時に上から順に評価する。
-   **編集:** ルールの追加/削除/並び替えに対応する。
-   **上限:** 1キャラクターあたり最大16行。将来的に増減する可能性がある。

-   **v1 ガンビットリスト（例）:**
| 条件 (Condition) | ターゲット (Target) | アクション (Action) | 優先度 |
| :--- | :--- | :--- | :--- |
| 味方のHP < 25% | HPが最も低い味方 | `大回復魔法` | 1 (最高) |
| 味方のHP < 50% | HPが最も低い味方 | `小回復魔法` | 2 |
| 敵が攻撃予兆 | 自分自身 | `防御する` | 3 |
| 敵に「非定型」がいる | 「非定型」の敵 | `攻撃魔法` | 4 |
| 敵に「定型」がいる | HPが最も低い敵 | `通常攻撃` | 5 |
| 常に | 先頭の敵 | `通常攻撃` | 6 (最低) |

#### 2.3.1 条件 (Condition) の種類
-   味方の状態 (例: `HPが75%以下の味方`)
-   敵の状態 (例: `HPが最も低い敵`, `敵が「攻撃予兆」状態`)
-   敵の種類 (例: `「非定型」の敵がいる`)
-   その他 (例: `常に`)
-   **v1実装済み:**
    -   敵/味方のHP/MP/攻撃/防御/素早さが最も低い/高い
    -   ランダムな敵/味方
    -   敵全体/味方全体
    -   敵が攻撃予兆
    -   定型の敵がいる / 非定型の敵がいる
    -   味方のHPが75%/50%/25%以下
    -   常に

#### 2.3.2 ターゲット (Target) の種類
-   自分自身
-   味方 (例: `HPが最も低い味方`, `ランダムな味方`)
-   敵 (例: `HPが最も低い敵`, `先頭の敵`, `自分を攻撃している敵`, `「非定型」の敵`)
-   **v1実装済み:**
    -   条件に合う味方/敵
    -   自分自身
    -   ランダムな味方/敵
    -   味方全体/敵全体
    -   HP/MP/攻撃/防御/素早さが最も低い/高い味方/敵
    -   先頭の敵
    -   自分を攻撃している敵

#### 2.3.3 アクション (Action) の種類
-   通常攻撃
-   防御
-   スキル/魔法 (例: `小回復魔法`, `攻撃魔法`)
-   アイテムの使用 (例: `MP回復薬を使う`)
-   **v1実装済み:**
    -   物理攻撃
    -   攻撃魔法
    -   大回復魔法 / 小回復魔法
    -   大治癒術 / 小治癒術
    -   防御
    -   回復薬を使う / 魔力水を使う

### 2.4 敵
-   **種別:**
    -   **定型 (Regular):** 主に物理攻撃に弱い。
    -   **非定型 (Irregular):** 主に魔法攻撃に弱い。
-   **攻撃予兆 (Telegraph):** 一部の強力な敵は、次ターンに強力な攻撃を繰り出すことを示す「攻撃予兆」状態になることがある。

-   **攻撃タイプと相性 (v1):**
| 攻撃タイプ | vs 定型 | vs 非定型 |
| :--- | :--- | :--- |
| **片手/両手武器** | 100% | 50% |
| **弓** | 66% | 100% |
| **攻撃魔法** | 50% | 150% |

### 2.5 ダンジョン
-   **探索:** 自動で進行し、一定間隔でイベント抽選（移動/戦闘/宝箱/罠）がログに記録される。
-   **フロア:** 現状はマップ生成なしのイベントループとして扱う。`seed` は保存するが未使用。
-   **敵遭遇:** 2-3体の敵がランダム出現（定型/非定型）。
-   **フロア移動:** 到達済みのフロアには、街から直接ジャンプできる。
-   **敗北:** パーティが全滅してもペナルティはなく、街へ自動的に帰還する。
-   **探索開始:** 街からフロアを選択し、探索を開始する。
-   **次フロア解放:** 一定回数の戦闘を終えると次フロアが解放される。

### 2.6 アイテムとインベントリ
-   **インベントリ容量:** 各キャラクターには所持アイテム数の上限がある。
-   **満杯時の挙動:**
    1.  アイテム入手時、インベントリに空きがない場合、ダイアログが表示される。
    2.  プレイヤーは「新しく入手するアイテム」と「現在の所持品」を比較する。
    3.  所持品の中から何かを一つ捨てることで、新しいアイテムを入手できる。捨てることを選ばない場合、新しいアイテムは入手できない。

### 2.7 セーブ
-   ゲームの状態はキャラクター/ダンジョン状態の変更時に自動でローカル保存される。
-   街メニューの `セーブ` から手動保存も可能。
-   `復活の呪文` (機種変更時のデータ移行コード) はv2以降で実装。

### 2.8 ショップと通貨
-   **通貨:** ゴールド。
-   **売買:** `Shop` でアイテムの購入/売却ができる。
-   **v1範囲:** 装備と消耗品の基本的なラインナップのみ。

---

## 3. 画面仕様

スケッチ (`Vermelha sketch.pdf`) を参考に、以下の画面を構成する。

1.  **タイトル画面:** `New Game` / `Load Game`
2.  **街画面 (メインメニュー):** Wizardry風のテキスト選択メニュー。
    -   `Tavern` (酒場): キャラクターの作成・管理。
    -   `Party` (パーティ): パーティ編成、キャラクター詳細の確認。
    -   `Shop` (店): アイテムの売買。
    -   `Dungeon` (ダンジョンへ): フロア選択へ進む。
    -   `Save` (セーブ): 手動セーブ (オートセーブの補助)。
3.  **酒場 (Tavern) 画面:** キャラクターの作成/編集/削除、一覧表示。
4.  **パーティ編成画面:** 出撃メンバー3人を選択し、前衛/中衛/後衛へ配置。
5.  **キャラクター詳細画面:** ステータス、装備、インベントリ、優先パラメータ編集、ガンビットの確認・変更画面への遷移。
6.  **ガンビット編集画面:** 条件・ターゲット・アクションを選択し、ルールの追加・削除・並べ替えを行う。
7.  **ダンジョン選択画面:** 到達済みフロアの一覧から探索開始フロアを選ぶ。
8.  **ダンジョン探索画面:**
    -   パーティメンバーの簡易ステータス表示。
    -   探索ログの表示。
    -   操作: `Pause/Play` (探索の一時停止/再開), `Camp` (キャンプ), `Return to City` (街へ帰還)。
9.  **キャンプ画面:** HP/MPの全回復 (無制限)、および装備やガンビットの確認・編集ができる。

### 3.1 画面遷移 (v1)
-   `タイトル` → `街` / `ダンジョン探索` (探索中セーブがある場合)
-   `街` → `酒場` / `パーティ編成` / `ショップ` / `ダンジョン選択` / `セーブ`
-   `酒場` → `キャラクター詳細` → `ガンビット編集`
-   `パーティ編成` → `キャラクター詳細`
-   `ダンジョン選択` → `ダンジョン探索` → `キャンプ` → `ダンジョン探索`
-   `ダンジョン探索` → `街` (帰還)

### 3.2 画面設計 (最小コンポーネント/状態)
1.  **タイトル画面**
    -   **コンポーネント:** `New Game` / `Load Game` ボタン（探索中セーブがあればダンジョンへ復帰）。
    -   **状態:** 選択中のセーブスロット (将来対応)。
2.  **街画面 (メインメニュー)**
    -   **コンポーネント:** メニューリスト、ゴールド表示、出撃パーティの簡易表示。
    -   **状態:** 選択中メニュー項目。
3.  **酒場 (Tavern) 画面**
    -   **コンポーネント:** キャラクター一覧、`Create`/`Edit`/`Delete` ボタン。
    -   **状態:** 選択中キャラクター。
4.  **パーティ編成画面**
    -   **コンポーネント:** 前衛/中衛/後衛スロット、キャラクター一覧、詳細ボタン。
    -   **状態:** スロット割り当て、選択中キャラクター。
5.  **キャラクター詳細画面**
    -   **コンポーネント:** ステータス表示、装備スロット、所持品リスト、優先パラメータ編集、`ガンビット編集` への導線。
    -   **状態:** 選択中装備/アイテム。
6.  **ガンビット編集画面**
    -   **コンポーネント:** ルール一覧 (最大16行)、`追加`/`削除`/`並び替え`、条件/ターゲット/アクション選択UI。
    -   **状態:** 編集中ルール、選択中条件/ターゲット/アクション。
7.  **ショップ画面**
    -   **コンポーネント:** `Buy`/`Sell` タブ、商品リスト、所持品リスト、ゴールド表示。
    -   **状態:** 選択中アイテム、現在タブ。
8.  **ダンジョン選択画面**
    -   **コンポーネント:** 到達済みフロア一覧、次フロア解放条件の表示。
    -   **状態:** 選択中フロア。
9.  **ダンジョン探索画面**
    -   **コンポーネント:** パーティ簡易ステータス、探索ログ、行動タスク一覧、`Pause/Play`、`Camp`、`Return to City`。
    -   **状態:** `isPaused`、現在フロア、戦闘回数、ログバッファ。
10. **キャンプ画面**
    -   **コンポーネント:** パーティ一覧、全回復ボタン、装備/ガンビット導線。
    -   **状態:** 特になし (回復後は探索へ戻る)。

---

## 4. データモデル (v1)

### 4.1 `PlayerCharacter`
- `id`: int (DBの主キー)
- `uuid`?: String (UUID、v1では内部IDとしてのみ使用)
- `name`: String
- `job`: Job (Enum: `fighter`, `paladin`, ...)
- `level`: int
- `exp`: int
- `maxHp`: int
- `hp`: int
- `maxMp`: int
- `mp`: int
- `attack`: int
- `defense`: int
- `magicPower`: int
- `speed`: int
- `jobBonus`: Map<StatusParameter, int> (ジョブ差分、v1では小さな補正のみ)
- `priorityParameters`: List<StatusParameter> (現在は選択のみ、成長ロジック未実装)
- `battleRules`: List<BattleRule>
- `equipment`: Map<EquipmentSlot, Item?> (例: `rightHand`, `armor`, `accessory`)
- `inventory`: List<Item>
- `inventoryCapacity`: int (固定値)
- `partyPosition`?: PartyPosition (`forward`, `middle`, `rear`)
- `isActive`: bool

### 4.2 `BattleRule` (ガンビットルール)
- `id`?: int (DBの主キー)
- `owner`: PlayerCharacter (敵用ルールはバトル生成時に一時的に付与)
- `name`: String (現在は未使用)
- `condition`: `Condition` (UUIDで永続化)
- `target`: `Target` (UUIDで永続化)
- `action`: `Action` (UUIDで永続化)
- `priority`: int (優先順位、数値が小さいほど高い)

### 4.3 `Item`
- `id`: String
- `name`: String
- `type`: ItemType (Enum: `weapon`, `armor`, `consumable`)
- `effects`: Map<String, int> (例: `attack: 10`, `defense: 5`)
- `equipmentSlot`?: EquipmentSlot (例: `rightHand`, `armor`, `accessory`)
- `price`: int

### 4.4 `Enemy`
- `id`?: int
- `uuid`?: String
- `name`: String
- `type`: EnemyType (Enum: `regular`, `irregular`)
- `maxHp`: int
- `hp`: int
- `maxMp`: int
- `mp`: int
- `attack`: int
- `defense`: int
- `magicPower`: int
- `speed`: int
- `isTelegraphing`: bool (攻撃予兆フラグ)
- `dropTable`: List<ItemID> (v1ではデータモデルのみ実装)

### 4.5 `Party`
- `positions`: Map<PartyPosition, PlayerCharacterID?> (`forward`, `middle`, `rear`)
- **v1 実装メモ:** Partyモデルは保持するが、永続化は `PlayerCharacter.partyPosition` で管理し roster から導出する。

### 4.6 `GameState`
- `roster`: List<PlayerCharacter>
- `party`: Party
- `gold`: int
- `maxReachedFloor`: int
- `battleCountOnFloor`: int
- `battlesToUnlockNextFloor`: int
- `activeDungeon`?: DungeonState (探索中のみ)
- **v1 実装メモ:** Party は roster の `partyPosition` から導出する。
- **v1 実装メモ:** 次フロア解放の進捗は街に戻っても保持する。

### 4.7 `DungeonState`
- `floor`: int
- `seed`: String (v1では未使用だが保存する)
- `eventLog`: List<LogEntry>
- `isPaused`: bool
- `battleCountOnFloor`: int
- `battlesToUnlockNextFloor`: int

### 4.8 `LogEntry`
- `timestamp`: DateTime
- `type`: LogType (Enum: `explore`, `battle`, `loot`, `system`)
- `messageId`: LogMessageId (Enum: `explorationStart`, `explorationMove`, `explorationTreasure`, `explorationTrap`, `battleEncounter`, `battleAction`, `battleVictory`, `lootNone`, `lootGold`, `lootItem`, `campHeal`, `returnToCity`)
- `data`?: Map<String, String>

### 4.9 マイグレーション方針 (v1)
- 既存セーブデータでは `character.job_bonus` は NULL のため、読み込み時は空の補正として扱う。
- 既存セーブデータで `game_state.seed` が NULL の場合、探索中のみ読み込み時に UUID を補完する。
- Party は `character.party_position` から導出し、独立テーブルは持たない。

---

## 5. v1 マイルストーン（推奨実装順）

1.  **データモデル定義:** 上記データモデルのDartクラスを作成する。
2.  **キャラクター作成と表示:** 酒場(Tavern)でキャラクターを作成し、ステータスを表示する。
3.  **ガンビット編集機能:** ガンビットのルールを作成・編集・並べ替えできるUIを実装する。
4.  **戦闘ロジックの実装:** 2-3体の敵との戦闘をシミュレートし、ガンビットに従って行動が自動で実行され、ログが出力されることを確認する。
5.  **ダンジョン探索ループ:** ダンジョンに入り、自動で敵と遭遇し、戦闘が発生するサイクルを実装する。
6.  **成長と報酬:** 戦闘勝利時にゴールド/アイテムドロップが発生し、成長要素は装備更新に寄せる（経験値/レベルアップは今後）。
7.  **インベントリと装備:** 入手したアイテムを装備・売却できる機能を実装する。
8.  **セーブ/ロード機能:** ゲームの状態が保存され、再開できることを確認する。
